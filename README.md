# ⚔️ Discord 무기 강화 게임 봇

Discord에서 무기를 강화하고, 몬스터나 다른 유저와 배틀하는 RPG 스타일 게임 봇입니다.

## 📋 목차

- [주요 기능](#-주요-기능)
- [명령어](#-명령어)
- [게임 시스템](#-게임-시스템)
  - [무기 시스템](#무기-시스템)
  - [강화 시스템](#강화-시스템)
  - [전투 시스템](#전투-시스템)
  - [무기 손상/파괴 시스템](#무기-손상파괴-시스템)
- [설치 및 배포](#-설치-및-배포)
- [환경 변수](#-환경-변수)

---

## 🎮 주요 기능

- 🗡️ **무기 강화**: 무기를 강화하여 전투력을 높이세요
- ⚔️ **배틀**: 몬스터나 다른 유저와 전투
- 💰 **경제 시스템**: 출석, 전투, 판매로 골드 획득
- 🏆 **랭킹**: 서버 내 랭킹 경쟁
- 🖼️ **무기 이미지**: R2 스토리지를 통한 무기 이미지 표시

---

## 📝 명령어

| 명령어 | 설명 |
|--------|------|
| `/정보 @유저` | 내 프로필 확인 (무기, 자금, 승리 횟수) 또는 상대방 프로필 확인 |
| `/출석` | 일일 출석 보상 (200,000원) |
| `/강화` | 무기 강화 시도 |
| `/배틀` | 랜덤 몬스터 또는 유저와 전투 |
| `/배틀 @유저` | 특정 유저와 전투 |
| `/판매` | 현재 무기 판매 후 새 무기 획득 |
| `/묵념` | 소액 골드 획득 (10~109원) |
| `/랭킹` | 서버 TOP 5 랭킹 확인 |
| `/파산` | 모든 정보 초기화 (200,000원으로 재시작) |

---

## 🎯 게임 시스템

### 무기 시스템

> **💡 모듈화**: 무기 정보는 D1 데이터베이스의 `weapons` 테이블에서 관리됩니다. 하드코딩된 무기 리스트 대신 데이터베이스에서 동적으로 조회하여 사용합니다.

#### 무기 종류
게임에는 3가지 무기 타입과 다양한 등급이 있습니다:

| 타입 | 무기 목록 |
|------|----------|
| ⚔️ **검** | 나무 검, 철 검, 강철 검, 미스릴 검, 다이아몬드 검, 드래곤 슬레이어, 신의 검, 전설의 검 |
| 🪓 **도끼** | 나무 도끼, 철 도끼, 강철 도끼, 미스릴 도끼, 다이아몬드 도끼, 드래곤 도끼, 신의 도끼, 전설의 도끼 |
| 🪄 **지팡이** | 나무 지팡이, 마법 지팡이, 고대 지팡이, 신의 지팡이, 전설의 지팡이 |

#### 무기 기본 가격 (판매 가격 계산 기준)

| 등급 | 검 | 도끼 | 지팡이 |
|------|-----|------|--------|
| 나무 | 100원 | 150원 | 200원 |
| 철/마법 | 500원 | 600원 | 800원 |
| 강철/고대 | 1,000원 | 1,200원 | 1,500원 |
| 미스릴 | 2,000원 | 2,500원 | - |
| 다이아몬드 | 5,000원 | 6,000원 | - |
| 드래곤 | 10,000원 | 12,000원 | - |
| 신 | 20,000원 | 25,000원 | 3,000원 |
| 전설 | 50,000원 | 60,000원 | 8,000원 |

#### 판매 가격 계산

무기 등급에 따라 판매 가격 공식이 다릅니다:

| 등급 | 계산 공식 | 예시 (13강 기준) |
|------|----------|------------------|
| **전설급** | `basePrice × (20 + level × 5)` | 전설의 지팡이: 8,000 × 85 = 680,000원 |
| **신급** | `basePrice × (10 + level × 2)` | 신의 지팡이: 3,000 × 36 = 108,000원 |
| **드래곤급** | `basePrice × (5 + level)` | 드래곤 슬레이어: 10,000 × 18 = 180,000원 |
| **다이아몬드급** | `basePrice × (3 + level × 0.5)` | 다이아몬드 검: 5,000 × 9.5 = 47,500원 |
| **미스릴급** | `basePrice × (2 + level × 0.3)` | 미스릴 검: 2,000 × 5.9 = 11,800원 |
| **일반/고급** | `basePrice + (level × 1,000)` | 강철 검: 1,000 + 13,000 = 14,000원 |

---

### 강화 시스템

#### 강화 비용
```
강화 비용 = (현재 레벨 × 1,000) + 500원
```

| 현재 강화 | 비용 |
|-----------|------|
| +0강 → +1강 | 500원 |
| +5강 → +6강 | 5,500원 |
| +10강 → +11강 | 10,500원 |
| +15강 → +16강 | 15,500원 |

#### 강화 확률

| 결과 | 확률 계산 |
|------|----------|
| ✅ **성공** | `max(10%, 100% - 레벨 × 5%)` |
| 💥 **파괴** | 구간별 관리 (아래 표 참조) |
| ❌ **실패** | `100% - 성공률 - 파괴율` |

#### 파괴 확률 구간

| 강화 구간 | 파괴 확률 범위 |
|-----------|---------------|
| 0~5강 | 0.0% ~ 6.0% |
| 6~10강 | 7.0% ~ 13.0% |
| 11~15강 | 14.0% ~ 21.0% |
| 16~20강 | 22.0% ~ 28.0% |
| 21강 이상 | 28.0% (최대) |

> 💡 **참고**: 파괴 확률은 소수점 1자리로 표시됩니다 (예: 2.4%, 6.0%).

#### 강화 확률 표

| 현재 강화 | 성공 | 실패 | 파괴 |
|-----------|------|------|------|
| +0강 | 100% | 0% | 0% |
| +5강 | 75% | 19% | 6% |
| +10강 | 50% | 37% | 13% |
| +15강 | 25% | 54% | 21% |
| +20강 | 10% | 62% | 28% |
| +21강 이상 | 10% | 62% | 28% |

> ⚠️ **파괴 시**: 무기가 파괴되고 랜덤한 새 무기 +0강으로 교체됩니다.

---

### 전투 시스템

#### 전투력 계산
```
기본 전투력 = (무기 레벨 × 15) + 40
실제 전투력 = 기본 전투력 × (0.8 ~ 1.2) [랜덤 ±20%]
```

| 무기 레벨 | 기본 전투력 | 실제 범위 |
|-----------|-------------|-----------|
| +0강 | 40 | 32 ~ 48 |
| +5강 | 115 | 92 ~ 138 |
| +10강 | 190 | 152 ~ 228 |
| +15강 | 265 | 212 ~ 318 |

#### 몬스터 레벨 생성
```
몬스터 레벨 = 플레이어 레벨 + (-5 ~ +10)
```

#### 전투 보상 (몬스터 전투)

| 레벨 격차 | 보상 계산 | 예시 |
|-----------|----------|------|
| 몬스터가 더 강함 (+N) | `1,000 + (N × 200)원` | +5격차: 2,000원 |
| 동일 레벨 (0) | `1,000원` | - |
| 몬스터가 더 약함 (-N) | `max(200원, 1,000 - N × 100)원` | -5격차: 500원 |

#### 유저 전투

| 결과 | 보상/패널티 |
|------|------------|
| ⚔️ **승리** | +2,000원 |
| 💀 **패배** | -500원 |

---

### 무기 손상/파괴 시스템

**패배 시** 전투력 차이에 따라 무기가 손상되거나 파괴될 수 있습니다.

#### 전투력 차이 계산
```
전투력 차이(%) = (상대 전투력 - 내 전투력) / 내 전투력 × 100
```

#### 손상/파괴 확률

| 전투력 차이 | 손상 확률 | 파괴 확률 | 설명 |
|------------|----------|----------|------|
| 0% ~ 30% | 15% | 3% | 차이가 작음 |
| 30% ~ 80% | 25% | 5% | 보통 차이 |
| 80% ~ 150% | 40% | 12% | 큰 차이 |
| 150% 이상 | 60% | 25% | 매우 큰 차이 |

#### 손상/파괴 결과

| 결과 | 효과 |
|------|------|
| ⚙️ **손상** | 무기 레벨 -1 (예: +10강 → +9강) |
| 💥 **파괴** | 무기 파괴, 랜덤 새 무기 +0강으로 교체 |

> 💡 **참고**: 무기 레벨이 0이면 손상이 발생해도 레벨이 내려가지 않습니다.

---

## 🚀 설치 및 배포

### 1. 의존성 설치
```bash
npm install
```

### 2. 데이터베이스 마이그레이션
```bash
# 기본 스키마 생성 (users 테이블)
npx wrangler d1 execute game-db --file=./schema.sql

# 무기 테이블 생성 및 데이터 삽입
npx wrangler d1 execute game-db --file=./migrate_weapons.sql

# AI 응답 템플릿 삽입 (선택사항)
npx wrangler d1 execute game-db --file=./templates.sql
```

### 3. 명령어 등록
```bash
node register.js
```

### 4. Cloudflare Workers 배포
```bash
npx wrangler deploy
```

### 5. 이미지 업로드 (R2)
```bash
node scripts/upload-images.js
```

---

## 🔧 환경 변수

| 변수명 | 설명 |
|--------|------|
| `DISCORD_PUBLIC_KEY` | Discord 애플리케이션 공개 키 |
| `DISCORD_APPLICATION_ID` | Discord 애플리케이션 ID |
| `DISCORD_TOKEN` | Discord 봇 토큰 |
| `R2_PUBLIC_URL` | R2 버킷 공개 URL (이미지용) |

### wrangler.jsonc 설정

```jsonc
{
  "name": "discord-game-bot",
  "main": "src/index.js",
  "compatibility_date": "2024-01-01",
  "d1_databases": [
    {
      "binding": "game_db",
      "database_name": "game-db",
      "database_id": "YOUR_DB_ID"
    }
  ],
  "r2_buckets": [
    {
      "binding": "WEAPON_IMAGES",
      "bucket_name": "weapon-images"
    }
  ]
}
```

---

## 📁 프로젝트 구조

```
discord-game-bot/
├── src/
│   ├── index.js                    # 메인 라우터 (요청 처리 및 라우팅)
│   ├── commands/                   # 명령어 모듈
│   │   ├── info.js                 # /정보 명령어
│   │   ├── daily.js                # /출석 명령어
│   │   ├── enhance.js              # /강화 명령어
│   │   ├── battle.js               # /배틀 명령어
│   │   ├── mourn.js                # /묵념 명령어
│   │   ├── sell.js                 # /판매 명령어
│   │   ├── ranking.js              # /랭킹 명령어
│   │   └── bankruptcy.js           # /파산 명령어
│   ├── modules/                    # 핵심 로직 모듈
│   │   ├── weapons.js              # 무기 관련 함수 (DB 기반)
│   │   ├── battle.js               # 전투 관련 함수
│   │   └── user.js                 # 유저 관련 함수
│   ├── handlers/                   # 버튼 핸들러
│   │   ├── enhance-button.js       # 강화 버튼 처리
│   │   ├── battle-button.js        # 배틀 버튼 처리
│   │   ├── mourn-button.js         # 묵념 버튼 처리
│   │   └── bankruptcy-button.js    # 파산 버튼 처리
│   └── utils/                      # 유틸리티 함수
│       ├── responses.js            # Discord 응답 생성
│       └── ai.js                   # AI 응답 처리
├── image/                          # 무기 이미지 파일
├── scripts/
│   ├── upload-images.js            # R2 이미지 업로드 스크립트
│   └── generate-templates.js       # AI 템플릿 생성
├── test/
│   └── index.spec.js               # 테스트 코드
├── schema.sql                       # 데이터베이스 스키마 (users 테이블)
├── migrate_weapons.sql             # 무기 테이블 마이그레이션
├── templates.sql                    # AI 응답 템플릿
├── register.js                      # Discord 명령어 등록
├── wrangler.jsonc                   # Cloudflare Workers 설정
└── package.json
```

---

## 📊 데이터베이스 스키마

### users 테이블
```sql
CREATE TABLE users (
  id TEXT PRIMARY KEY,           -- Discord 유저 ID
  username TEXT,                 -- 유저명
  weapon_name TEXT,              -- 현재 무기 이름 (weapons 테이블 참조)
  level INTEGER DEFAULT 0,       -- 강화 레벨
  money INTEGER DEFAULT 200000,  -- 보유 골드
  wins INTEGER DEFAULT 0,        -- 승리 횟수
  last_daily TEXT                -- 마지막 출석일
);
```

### weapons 테이블
```sql
CREATE TABLE weapons (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT UNIQUE NOT NULL,     -- 무기 이름
  base_price INTEGER NOT NULL,   -- 기본 가격
  description TEXT NOT NULL,      -- 무기 설명
  weapon_type TEXT NOT NULL,     -- 무기 타입 (검/도끼/지팡이)
  tier TEXT NOT NULL,            -- 등급 (일반/고급/강철/미스릴/다이아몬드/드래곤/신/전설)
  image_filename TEXT            -- 이미지 파일명
);
```

### ai_responses 테이블
```sql
CREATE TABLE ai_responses (
  id INTEGER PRIMARY KEY,
  result_type TEXT,              -- 결과 타입 (success, failure, destroyed)
  response TEXT                  -- 응답 템플릿
);
```

> **참고**: 무기 정보는 이제 하드코딩되지 않고 데이터베이스에서 관리됩니다. 새로운 무기를 추가하거나 기존 무기 정보를 수정하려면 `weapons` 테이블을 업데이트하면 됩니다.

---

## 🛠️ 개발 가이드

### 코드 구조

이 프로젝트는 모듈화된 구조로 설계되었습니다:

- **명령어 모듈** (`src/commands/`): 각 Discord 슬래시 명령어의 로직을 독립적인 모듈로 분리
- **핵심 로직 모듈** (`src/modules/`): 무기, 전투, 유저 관련 핵심 비즈니스 로직
- **버튼 핸들러** (`src/handlers/`): Discord 버튼 인터랙션 처리
- **유틸리티** (`src/utils/`): 공통 유틸리티 함수들

### 무기 데이터 관리

무기 정보는 `weapons` 테이블에서 관리됩니다. 새로운 무기를 추가하려면:

```sql
INSERT INTO weapons (name, base_price, description, weapon_type, tier, image_filename) 
VALUES ('새 무기', 1000, '설명', '검', '일반', 'new_weapon.png');
```

무기 정보 수정도 데이터베이스 쿼리로 직접 수행할 수 있습니다.

### 데이터베이스 마이그레이션

로컬 개발 환경에서 마이그레이션을 테스트하려면:

```bash
# 로컬 D1 데이터베이스에 마이그레이션 실행
npx wrangler d1 execute game-db --local --file=./migrate_weapons.sql
```

프로덕션 환경에 적용하려면:

```bash
# 프로덕션 D1 데이터베이스에 마이그레이션 실행
npx wrangler d1 execute game-db --file=./migrate_weapons.sql
```

---

## 📜 라이선스

MIT License

---

## 🤝 기여

버그 리포트나 기능 제안은 Issues를 통해 제출해주세요!
